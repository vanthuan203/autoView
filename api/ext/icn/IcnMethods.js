const BG=window.BG={Methods:{},statusSettings:{id:RQ.STORAGE_KEYS.REQUESTLY_SETTINGS,avoidCache:!0,isExtensionEnabled:!0},userInfo:{id:RQ.STORAGE_KEYS.USER_INFO,avoidCache:!0,installationDate:Date.now(),planName:"",isLoggedIn:""},remoteRulesSettings:{enabled:!1},remoteRulesImportJobId:-1,remoteRulesGroupId:"Group_remote_rules",extensionStatusContextMenuId:-1,modifiedRequestsPool:new Queue(1e3)};function buildExecutionLogObject({ruleName:e,requestDetails:t,modification:o}){return{id:RQ.Utils.generateExecutionLogId(),requestMethod:t.method,timestamp:t.timeStamp,url:t.url,requestType:t.type,ruleName:e,modification:o}}function appendExecutionLog(e,t){if(e){const o=[...e];return o.length===RQ.LIMITS.NUMBER_EXECUTION_LOGS&&o.shift(),[...o,t]}return[t]}function buildExecutionCountObject({existingExecutionCount:e,ruleType:t}){const o=new Date,s=o.getMonth()+1,r=o.getFullYear();return(e=e||{})?.[r]?.[s]?.[t]?e[r][s][t]=e[r][s][t]+1:RQ.Utils.setObjectValueAtPath(e,`${r}.${s}.${t}`,1),e}BG.Methods.applyReplaceRule=function(e,t,o){let s,r=e.pairs,n=null,a=null,i=t;for(let e=0;e<r.length;e++)n=r[e],n.from=n.from||"",n.source&&!RuleMatcher.matchRequestWithRuleSourceFilters(n.source.filters,o)||n.source&&n.source.value&&null===RuleMatcher.matchUrlWithRuleSource(n.source,i)||(a=RQ.Utils.toRegex(n.from),s=null!==a,a=a||n.from,(s&&i.match(a)||-1!==i.indexOf(a))&&(i=i.replace(a,n.to)));return i!==t?i:null},BG.Methods.applyQueryParamModification=function(e,t){var o=t,s=RQ.Utils.getUrlWithoutQueryParamsAndHash(t),r=RQ.Utils.extractUrlComponent(t,RQ.URL_COMPONENTS.HASH),n=RQ.Utils.extractUrlComponent(t,RQ.URL_COMPONENTS.QUERY),a=RQ.Utils.getQueryParamsMap(n),i=e.param,u=e.value;switch(e.type){case RQ.MODIFICATION_TYPES.ADD:"Overwrite"===e.actionWhenParamExists&&(a[i]=[],a[i].push(u),o=(n=RQ.Utils.convertQueryParamMapToString(a))?s+"?"+n:s,o+=r),"Ignore"===e.actionWhenParamExists&&(o=t);break;case RQ.MODIFICATION_TYPES.REMOVE:i in a&&(delete a[i],o=(n=RQ.Utils.convertQueryParamMapToString(a))?s+"?"+n:s,o+=r);break;case RQ.MODIFICATION_TYPES.REMOVE_ALL:o=s+r}return o},BG.Methods.applyQueryParamModifications=function(e,t){var o=t;return e.forEach((function(e){o=BG.Methods.applyQueryParamModification(e,o)})),o},BG.Methods.applyQueryParamRule=function(e,t,o){for(var s=e.pairs,r=null,n=t,a=0;a<s.length;a++)r=s[a],RuleMatcher.matchRequestWithRuleSourceFilters(r.source.filters,o)&&null!==RuleMatcher.matchUrlWithRuleSource(r.source,t)&&(n=BG.Methods.applyQueryParamModifications(r.modifications,n));return n!==t?n:null},BG.Methods.applyDelayRequestRule=function(e,t,o){var s=e.pairs,r=null,n=t,a=null,i=null;const u={paramName:RQ.DELAY_REQUEST_CONSTANTS.DELAY_PARAM_NAME,paramValue:RQ.DELAY_REQUEST_CONSTANTS.DELAY_PARAM_VALUE};for(var d=0;d<s.length;d++)if(r=s[d],RuleMatcher.matchRequestWithRuleSourceFilters(r.source.filters,o)&&null!==RuleMatcher.matchUrlWithRuleSource(r.source,t)&&(!r.source||!r.source.value||null!==RuleMatcher.matchUrlWithRuleSource(r.source,n)))return n=RuleMatcher.matchValueForPredefinedFunctions(n,RQ.PreDefinedFunctions),a=r.delay,o.type!==RQ.DELAY_REQUEST_CONSTANTS.REQUEST_TYPE.XHR&&o.method===RQ.DELAY_REQUEST_CONSTANTS.METHOD_TYPE.GET?(i=RQ.DELAY_REQUEST_CONSTANTS.DELAY_TYPE.SERVER_SIDE,a=r.delay):(i=RQ.DELAY_REQUEST_CONSTANTS.DELAY_TYPE.CLIENT_SIDE,a=Math.min(r.delay,RQ.DELAY_REQUEST_CONSTANTS.MAX_DELAY_VALUE_XHR)),"serverSideDelay"===i?n=RQ.DELAY_API_URL+`${a}/${n}`:(n=RQ.Utils.addQueryParamToURL(n,u.paramName,u.paramValue,!1),RQ.Utils.addDelay(a)),n;return null},BG.Methods.addHeader=function(e,t){e.push({name:t.name,value:t.value})},BG.Methods.removeHeader=function(e,t){for(var o=e.length-1;o>=0;o--){var s=e[o];s.name&&s.name.toLowerCase()===t.toLowerCase()&&e.splice(o,1)}},BG.Methods.modifyHeaderIfExists=function(e,t){for(var o=e.length-1;o>=0;o--){var s=e[o];if(s.name&&s.name.toLowerCase()===t.name.toLowerCase()){s.value=t.value;break}}},BG.Methods.replaceHeader=function(e,t){BG.Methods.removeHeader(e,t.name),BG.Methods.addHeader(e,t)},BG.Methods.modifyHeaders=function(e,t,o){for(var s,r,n,a,i,u,d=!1,c=o.url,l=BG.Methods.getMainFrameUrl(o),R=BG.Methods.getEnabledRules(),E=0;E<R.length;E++)if(r=(s=R[E]).ruleType,-1!==[RQ.RULE_TYPES.HEADERS,RQ.RULE_TYPES.USERAGENT].indexOf(r)){n=s.pairs||[];for(var S=0;S<n.length;S++){if(a=n[S],s.version>1){if(!RuleMatcher.matchRequestWithRuleSourceFilters(a.source.filters,o))continue;i=a.modifications?.[t]||[]}else i=[a];for(var h=0;h<i.length;++h)if(u=i[h],r===RQ.RULE_TYPES.USERAGENT&&(u=BG.Methods.getUserAgentHeaderModification(u)),(s.version>1||u.target===t)&&u.header&&RuleMatcher.matchRequestWithRuleSourceFilters(a.source.filters,o)&&(!a.source||null!==RuleMatcher.matchUrlWithRuleSource(a.source,c)||r===RQ.RULE_TYPES.USERAGENT&&a.source.requestType===RQ.REQUEST_TYPES.MAIN_FRAME&&l&&null!==RuleMatcher.matchUrlWithRuleSource(a.source,l))){d=!0;var M=RuleMatcher.matchValueForPredefinedFunctions(u.value,RQ.PreDefinedFunctions);switch(u.type){case RQ.MODIFICATION_TYPES.ADD:BG.Methods.addHeader(e,{name:u.header,value:M});break;case RQ.MODIFICATION_TYPES.REMOVE:BG.Methods.removeHeader(e,u.header);break;case RQ.MODIFICATION_TYPES.MODIFY:BG.Methods.modifyHeaderIfExists(e,{name:u.header,value:M});break;case RQ.MODIFICATION_TYPES.REPLACE:BG.Methods.replaceHeader(e,{name:u.header,value:M})}BG.Methods.logRuleApplied(s,o,`modified ${t===RQ.HEADERS_TARGET.REQUEST?"request":"response"} headers`)}}}return d?e:null},BG.Methods.getMainFrameUrl=function(e){return window.tabService.getTabUrl(e.tabId)},BG.Methods.getUserAgentHeaderModification=function(e){return{target:RQ.HEADERS_TARGET.REQUEST,type:RQ.MODIFICATION_TYPES.REPLACE,header:RQ.HEADER_NAMES.USER_AGENT,value:e.userAgent}},BG.Methods.getMatchingRulePairs=function(e,t){return BG.statusSettings.isExtensionEnabled?BG.Methods.getEnabledRules().filter((function(e){return!t||e.ruleType===t})).reduce((function(t,o){var s=o.pairs.filter((function(t){return null!==RuleMatcher.matchUrlWithRuleSource(t.source,e)}));return t.concat(s)}),[]):[]},BG.Methods.getEnabledRules=function(){var e=[],t=[],o={};return cdnJS.forEach((function(e){e.objectType&&e.objectType!==RQ.OBJECT_TYPES.RULE?e.objectType===RQ.OBJECT_TYPES.GROUP&&(o[e.id]=e):t.push(e)})),t.forEach((function(t){var s=t.groupId&&o[t.groupId];t.status!==RQ.RULE_STATUS.ACTIVE||s&&s.status!==RQ.RULE_STATUS.ACTIVE||e.push(t)})),e},BG.Methods.getMatchingRules=function(e,t){return BG.statusSettings.isExtensionEnabled?BG.Methods.getEnabledRules().filter((function(o){return(!t||o.ruleType===t)&&null!==RuleMatcher.matchUrlWithRulePairs(o.pairs,e)})):[]},BG.Methods.modifyUrl=function(e){var t,o=e.url,s=null;if("options"!==e.method.toLowerCase()&&!(e.requestId&&BG.modifiedRequestsPool.getElementIndex(e.requestId)>-1)){t=BG.Methods.getEnabledRules();for(var r=0;r<t.length;r++){var n=t[r],a=null;switch(n.ruleType){case RQ.RULE_TYPES.REDIRECT:void 0!==n.source&&void 0!==n.destination&&(n.pairs=[{source:{key:RQ.RULE_KEYS.URL,operator:n.source.operator,value:n.source.values[0]},destination:n.destination}],delete n.source,delete n.destination),a=RuleMatcher.matchUrlWithRulePairs(n.pairs,o,e),a=RuleMatcher.matchValueForPredefinedFunctions(a,RQ.PreDefinedFunctions);break;case RQ.RULE_TYPES.CANCEL:void 0!==n.source&&(n.pairs=[{source:{key:RQ.RULE_KEYS.URL,operator:n.source.operator,value:n.source.values[0]}}],delete n.source),null!==(a=RuleMatcher.matchUrlWithRulePairs(n.pairs,o,e))&&(a="javascript:");break;case RQ.RULE_TYPES.REPLACE:a=BG.Methods.applyReplaceRule(n,o,e),a=RuleMatcher.matchValueForPredefinedFunctions(a,RQ.PreDefinedFunctions);break;case RQ.RULE_TYPES.QUERYPARAM:a=BG.Methods.applyQueryParamRule(n,o,e),a=RuleMatcher.matchValueForPredefinedFunctions(a,RQ.PreDefinedFunctions);break;case RQ.RULE_TYPES.DELAY:a=BG.Methods.applyDelayRequestRule(n,o,e)}a&&(o=s=a,BG.Methods.logRuleApplied(n,e,"redirected to "+s))}return s?(BG.modifiedRequestsPool.enQueue(e.requestId),{redirectUrl:s}):void 0}},BG.Methods.logRuleApplied=function(e,t,o){t.tabId!==chrome.tabs.TAB_ID_NONE&&(BG.Methods.setExtensionIconActive(t.tabId),BG.Methods.sendLogToDevTools(e,t,o),BG.Methods.saveExecutionLog(e,t,o),BG.Methods.sendLogToConsoleLogger(e,t,o),BG.Methods.saveExecutionCount(e))},BG.Methods.modifyRequestHeadersListener=function(e){var t=BG.Methods.modifyHeaders(e.requestHeaders,RQ.HEADERS_TARGET.REQUEST,e);if(null!==t)return{requestHeaders:t}},BG.Methods.onHeadersReceived=function(e){var t=BG.Methods.modifyHeaders(e.responseHeaders,RQ.HEADERS_TARGET.RESPONSE,e);if(BG.Methods.overrideResponse(e,t||e.responseHeaders),null!==t)return{responseHeaders:t}},BG.Methods.overrideResponse=function(e,t){let o=BG.Methods.getMatchingRules(e.url,RQ.RULE_TYPES.RESPONSE);if(o.length>0){const s=o[o.length-1];chrome.tabs.sendMessage(e.tabId,{action:RQ.CLIENT_MESSAGES.OVERRIDE_RESPONSE,url:e.url,responseHeaders:t,rule:{id:s.id,response:s.pairs[0].response,source:s.pairs[0].source}},{frameId:e.frameId})}},BG.Methods.getFavouriteRules=function(){return RQ.StorageService.records.filter((function(e){return e.objectType===RQ.OBJECT_TYPES.RULE&&e.isFavourite}))},BG.Methods.getPinnedGroups=function(e){const t={};return RQ.StorageService.records.forEach((e=>{e.objectType===RQ.OBJECT_TYPES.GROUP&&e.isFavourite&&(t[e.id]={...e,children:[]})})),e&&RQ.StorageService.records.forEach((e=>{e.objectType&&e.objectType!==RQ.OBJECT_TYPES.RULE||e.groupId&&t[e.groupId]&&t[e.groupId].children.push(e)})),Object.values(t)},BG.Methods.registerListeners=function(){if(chrome.webRequest.onBeforeRequest.hasListener(BG.Methods.modifyUrl)||chrome.webRequest.onBeforeRequest.addListener(BG.Methods.modifyUrl,{urls:["<all_urls>"]},["blocking"]),!chrome.webRequest.onBeforeSendHeaders.hasListener(BG.Methods.modifyRequestHeadersListener)){var e=["blocking","requestHeaders"];chrome.webRequest.OnBeforeSendHeadersOptions.EXTRA_HEADERS&&e.push(chrome.webRequest.OnBeforeSendHeadersOptions.EXTRA_HEADERS),chrome.webRequest.onBeforeSendHeaders.addListener(BG.Methods.modifyRequestHeadersListener,{urls:["<all_urls>"]},e)}if(!chrome.webRequest.onHeadersReceived.hasListener(BG.Methods.onHeadersReceived)){var t=["blocking","responseHeaders"];chrome.webRequest.OnHeadersReceivedOptions.EXTRA_HEADERS&&t.push(chrome.webRequest.OnHeadersReceivedOptions.EXTRA_HEADERS),chrome.webRequest.onHeadersReceived.addListener(BG.Methods.onHeadersReceived,{urls:["<all_urls>"]},t)}},BG.Methods.unregisterListeners=function(){chrome.webRequest.onBeforeRequest.removeListener(BG.Methods.modifyUrl),chrome.webRequest.onBeforeSendHeaders.removeListener(BG.Methods.modifyRequestHeadersListener),chrome.webRequest.onHeadersReceived.removeListener(BG.Methods.onHeadersReceived)},BG.Methods.disableExtension=function(){BG.statusSettings.isExtensionEnabled=!1,RQ.StorageService.saveRecord({rq_settings:BG.statusSettings}).then(BG.Methods.handleExtensionDisabled)},BG.Methods.enableExtension=function(){BG.statusSettings.isExtensionEnabled=!0,RQ.StorageService.saveRecord({rq_settings:BG.statusSettings}).then(BG.Methods.handleExtensionEnabled)},BG.Methods.handleExtensionDisabled=function(){BG.Methods.unregisterListeners(),chrome.contextMenus.update(BG.extensionStatusContextMenuId,{title:"Activate Requestly",onclick:BG.Methods.enableExtension}),chrome.browserAction.setIcon({path:RQ.RESOURCES.EXTENSION_ICON_GREYSCALE}),BG.Methods.sendMessage({isExtensionEnabled:!1}),Logger.log("Requestly disabled")},BG.Methods.handleExtensionEnabled=function(){BG.Methods.registerListeners(),chrome.contextMenus.update(BG.extensionStatusContextMenuId,{title:"Deactivate Requestly",onclick:BG.Methods.disableExtension}),BG.Methods.sendMessage({isExtensionEnabled:!0}),Logger.log("Requestly enabled")},BG.Methods.setExtensionIconActive=function(e){chrome.tabs.get(e,(function(t){if(t)if("complete"===t.status);else{var o=function(t,s){t===e&&"complete"===s.status&&chrome.tabs.onUpdated.removeListener(o)};chrome.tabs.onUpdated.addListener(o)}}))},BG.Methods.readExtensionStatus=function(){RQ.StorageService.getRecord(RQ.STORAGE_KEYS.REQUESTLY_SETTINGS).then((e=>{BG.statusSettings=e||BG.statusSettings,BG.statusSettings.isExtensionEnabled?BG.Methods.handleExtensionEnabled():BG.Methods.handleExtensionDisabled()}))},BG.Methods.createContextMenu=function(e,t,o){return chrome.contextMenus.create({title:e,type:"normal",contexts:t,onclick:"function"==typeof o||function(){console.log("Requestly Default handler executed")}})},BG.Methods.sendMessage=function(e,t){t=t||function(){console.log("DefaultHandler: Sending Message to Runtime: ",e)}},BG.Methods.handleExtensionInstalledOrUpdated=function(e){"install"===e.reason&&(RQ.StorageService.saveRecord({user_info:BG.userInfo}),chrome.tabs.create({url:RQ.configs.WEB_URL+"/extension-installed"})),Logger.log("ICN9: "+e.reason)},BG.Methods.doSetupResponseRuleHandler=function(){const e=BG.Methods.getEnabledRules().filter((e=>e.ruleType===RQ.RULE_TYPES.RESPONSE));return BG.statusSettings.isExtensionEnabled&&e.length>0},BG.Methods.addListenerForExtensionMessages=function(){chrome.runtime.onMessage.addListener((function(e,t,o){switch(e.action){case RQ.CLIENT_MESSAGES.GET_SCRIPT_RULES:e.url&&o(BG.Methods.getMatchingRules(e.url,RQ.RULE_TYPES.SCRIPT));break;case RQ.CLIENT_MESSAGES.DO_SETUP_RESPONSE_RULE_HANDLER:o(BG.Methods.doSetupResponseRuleHandler());break;case RQ.CLIENT_MESSAGES.GET_USER_AGENT_RULE_PAIRS:e.url&&o(BG.Methods.getMatchingRulePairs(e.url,RQ.RULE_TYPES.USERAGENT));break;case RQ.CLIENT_MESSAGES.NOTIFY_RULES_APPLIED:e.rules&&e.rules.forEach((function(o){BG.Methods.logRuleApplied(o,{tabId:t.tab.id,url:e.url,method:e.method,type:e.type,timeStamp:e.timeStamp},e.modification)})),e.ruleIds&&e.ruleIds.forEach((o=>{RQ.StorageService.getRecord(o).then((o=>{BG.Methods.logRuleApplied(o,{tabId:t.tab.id,url:e.url,method:e.method,type:e.type,timeStamp:e.timeStamp},e.modification)}))}));break;case RQ.EXTENSION_MESSAGES.FOCUS_TAB:e.tabId&&o(window.tabService.focusTab(e.tabId));break;case RQ.EXTENSION_MESSAGES.GET_FAVOURITE_RULES:o(BG.Methods.getFavouriteRules());break;case RQ.EXTENSION_MESSAGES.GET_PINNED_GROUPS:o(BG.Methods.getPinnedGroups(e.populateChildren));break;case RQ.EXTENSION_MESSAGES.GET_FLAGS:o(RQ.flags);break;case RQ.CLIENT_MESSAGES.GET_SESSION_RECORDING_CONFIG:return BG.Methods.getSessionRecordingConfig(t.tab.url).then(o),!0;case RQ.CLIENT_MESSAGES.NOTIFY_SESSION_RECORDING_STARTED:BG.Methods.onSessionRecordingStartedNotification(t.tab.id);break;case RQ.EXTENSION_MESSAGES.GET_TAB_SESSION:return BG.Methods.getTabSession(e.tabId,o),!0}}))},BG.Methods.getSessionRecordingConfig=async e=>{const t=await RQ.StorageService.getRecord(RQ.STORAGE_KEYS.SESSION_RECORDING_CONFIG);return(t?.pageSources||[]).some((t=>null!==RuleMatcher.matchUrlWithPageSource(t,e)))?t:null},BG.Methods.onSessionRecordingStartedNotification=e=>{chrome.browserAction.setBadgeText({tabId:e,text:"REC"}),chrome.browserAction.setBadgeBackgroundColor({tabId:e,color:"#e34850"})},BG.Methods.cleanUpRemoteRulesGroup=function(){return new Promise((e=>{RQ.StorageService.getRecord(BG.remoteRulesGroupId).then((e=>{if(!e||!e.status){const e={id:BG.remoteRulesGroupId,objectType:RQ.OBJECT_TYPES.GROUP,name:"Remote Server Rules (Imported Periodically - Do not Edit)",status:RQ.RULE_STATUS.ACTIVE,creationDate:Date.now()};return RQ.StorageService.saveRecordWithID(e)}})).then((()=>{RQ.StorageService.getRecords(RQ.OBJECT_TYPES.RULE).then((t=>{const o=[];t.forEach((e=>e.groupId===BG.remoteRulesGroupId&&o.push(e.id))),Logger.log("Removing records from Remote Group",o),o.length>0?RQ.StorageService.removeRecord(o).then(e):e()}))}))}))},BG.devtools={},BG.Methods.listenDevtools=function(){chrome.runtime.onConnect.addListener((function(e){"rq_devtools"===e.name&&(e.onMessage.addListener((function(t){"registerDevTool"===t.action&&(BG.devtools[t.tabId]=e)})),e.onDisconnect.addListener((function(){const t=Object.keys(BG.devtools).find((t=>BG.devtools[t]===e));delete BG.devtools[t]})))}))},BG.Methods.sendLogToDevTools=function(e,t,o){const s=BG.devtools[t.tabId];s&&s.postMessage({rule:e,modification:o,timestamp:t.timeStamp||Date.now(),requestURL:t.url,requestType:t.type,requestMethod:t.method})},BG.Methods.saveExecutionLog=async function(e,t,o){const s=`execution_${e.id}`,r=appendExecutionLog(await RQ.StorageService.getRecord(s),buildExecutionLogObject({ruleName:e.name,requestDetails:t,modification:o}));RQ.StorageService.saveRecord({[s]:r})},BG.Methods.sendLogToConsoleLogger=async function(e,t,o){const s=RQ.CONSOLE_LOGGER_ENABLED,r=await RQ.StorageService.getRecord(s);chrome.tabs.sendMessage(t.tabId,{action:RQ.PRINT_CONSOLE_LOGS,requestDetails:t,rule:e,modification:o,isConsoleLoggerEnabled:r},{frameId:t.frameId})},BG.Methods.saveExecutionCount=async function(e){const t=buildExecutionCountObject({existingExecutionCount:await RQ.StorageService.getRecord("ec"),ruleType:e.ruleType});RQ.StorageService.saveRecord({ec:t})},BG.Methods.getTabSession=(e,t)=>{chrome.tabs.sendMessage(e,{action:RQ.CLIENT_MESSAGES.GET_TAB_SESSION},{frameId:0},t)},BG.Methods.init=function(){chrome.contextMenus.removeAll(),BG.extensionStatusContextMenuId=BG.Methods.createContextMenu(RQ.MESSAGES.DEACTIVATE_REQUESTLY_MENU_OPTION,RQ.configs.contextMenuContexts),StorageService.getInstance({cacheRecords:!0},RQ).then((()=>{chrome.runtime.onInstalled.addListener(BG.Methods.handleExtensionInstalledOrUpdated),Logger.log("StorageService Initialized",RQ.StorageService),RQ.StorageService.getRecords().then(BG.Methods.readExtensionStatus)})),BG.Methods.addListenerForExtensionMessages(),BG.Methods.listenDevtools()},function(){try{BG.Methods.init()}catch(e){}}();