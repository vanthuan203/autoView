window.RQ=window.RQ||{},RQ.ContentScriptMessageHandler={eventCallbackMap:{},requestId:1,constants:{CONTENT_SCRIPT:"content_script",PAGE_SCRIPT:"page_script",DOMAIN:RQ.configs.WEB_URL,SOURCE_FIELD:"source",ACTION_USER_LOGGED_IN:"user:loggedIn"},addMessageListener:function(){window.addEventListener("message",this.handleMessageReceived.bind(this))},getSource:function(){return this.constants.CONTENT_SCRIPT},registerCallback:function(e,t){if(!t)return;const r=this.requestId++;this.eventCallbackMap[e.action+"_"+r]=t,e.requestId=r},invokeCallback:function(e){const t=this.eventCallbackMap[e.data.action+"_"+e.data.requestId];"function"==typeof t&&(delete this.eventCallbackMap[e.data.action],t.call(this,e.data.response))},sendMessage:function(e,t){e.action?(this.registerCallback(e,t),e[this.constants.SOURCE_FIELD]=this.getSource(),window.postMessage(e,this.constants.DOMAIN)):Logger.error("Invalid message. Must contain some action")},sendResponse:function(e,t){const r={action:e.action,requestId:e.requestId,response:t};r[this.constants.SOURCE_FIELD]=this.constants.CONTENT_SCRIPT,window.postMessage(r,this.constants.DOMAIN)},handleMessageReceived:function(e){const t=this;if(e&&e.origin!==RQ.configs.WEB_URL)"debug"===RQ.configs.logLevel&&console.log("Ignoring message from the following domain",e.origin,e.data);else if(e&&e.data&&e.data.source===this.constants.PAGE_SCRIPT){if("debug"===RQ.configs.logLevel&&console.log("Received message:",e.data),void 0!==e.data.response)return this.invokeCallback(e);"GET_STORAGE_TYPE"===e.data.action?StorageService.getStorageType().then((r=>{t.sendResponse(e.data,{storageType:r})})):"SET_STORAGE_TYPE"===e.data.action?StorageService.setStorageType(e.data.storageType).then((()=>{t.sendResponse(e.data,{success:!0})})):"GET_STORAGE_INFO"===e.data.action?StorageService.getStorageType().then((r=>{chrome.storage[r].get(null,(n=>{const a=[];for(let e in n)(n[e].hasOwnProperty("objectType")||n[e].hasOwnProperty("ruleType"))&&a.push(n[e]);t.sendResponse(e.data,{storageType:r,numItems:a.length,bytesUsed:JSON.stringify(a).length})}))})):"GET_STORAGE_SUPER_OBJECT"===e.data.action?StorageService.getStorageType().then((r=>{chrome.storage[r].get(null,(r=>{t.sendResponse(e.data,r)}))})):"GET_STORAGE_OBJECT"===e.data.action?StorageService.getStorageType().then((r=>{chrome.storage[r].get(e.data.key,(r=>{t.sendResponse(e.data,r[e.data.key])}))})):"SAVE_STORAGE_OBJECT"===e.data.action?StorageService.getStorageType().then((r=>{chrome.storage[r].set(e.data.object,(()=>{t.sendResponse(e.data)}))})):"REMOVE_STORAGE_OBJECT"===e.data.action?StorageService.getStorageType().then((r=>{chrome.storage[r].remove(e.data.key,(()=>{t.sendResponse(e.data)}))})):"CLEAR_STORAGE"===e.data.action?StorageService.getStorageType().then((r=>{chrome.storage[r].clear((()=>{t.sendResponse(e.data)}))})):"GET_USER_INFO"===e.data.action?StorageService.getRecordFromStorage("user_info","sync").then((r=>t.sendResponse(e.data,r||{}))):[RQ.EXTENSION_MESSAGES.FOCUS_TAB,RQ.EXTENSION_MESSAGES.GET_FULL_LOGS,RQ.EXTENSION_MESSAGES.CLEAR_LOGS_FOR_TAB,RQ.EXTENSION_MESSAGES.CLEAR_LOGS_FOR_DOMAIN,RQ.EXTENSION_MESSAGES.GET_FLAGS,RQ.EXTENSION_MESSAGES.GET_TAB_SESSION].includes(e.data.action)&&this.delegateMessageToBackground(e.data)}},delegateMessageToBackground:function(e){const t=this;chrome.runtime.sendMessage(e,(r=>{t.sendResponse(e,r)}))},init:function(){this.addMessageListener()}},RQ.ContentScriptMessageHandler.init(),window.RQ=window.RQ||{},RQ.DataStoreUtils={isUserAuthenticated:function(e){RQ.ContentScriptMessageHandler.sendMessage({action:RQ.DATASTORE.ACTIONS.CHECK_USER_AUTH},e)},fetchUserDetails:function(){return new Promise(((e,t)=>{try{RQ.ContentScriptMessageHandler.sendMessage({action:RQ.DATASTORE.ACTIONS.FETCH_USER_DETAILS},e)}catch(e){t(e)}}))},authenticate:function(e){RQ.ContentScriptMessageHandler.sendMessage({action:RQ.DATASTORE.ACTIONS.AUTHENTICATE},e)},getValue:function(e){return new Promise(((t,r)=>{try{RQ.ContentScriptMessageHandler.sendMessage({action:RQ.DATASTORE.ACTIONS.GETVALUE,pathArray:e},t)}catch(e){r(e)}}))},setValue:function(e,t,r){RQ.ContentScriptMessageHandler.sendMessage({action:RQ.DATASTORE.ACTIONS.SETVALUE,pathArray:e,value:t},r)}},window.RQ=window.RQ||{},RQ.DOMUtils=RQ.DOMUtils||{},RQ.DOMUtils.toggleClass=function(e,t,r){r?e.addClass(t):e.removeClass(t)},function(e){e.StorageService&&"function"==typeof e.StorageService||(e.StorageService=class{static getInstance(e,t){return new Promise((r=>{StorageService.getStorageType().then((n=>{e.DB=n,t.StorageService=new StorageService(e),r()}))}))}constructor(e){this.DB=e.DB?chrome.storage[e.DB]:chrome.storage[RQ.configs.storageType],this.primaryKeys=e.primaryKeys||["objectType","ruleType"],this.records=[],this.isRecordsFetched=!1,this.cachingEnabled=e.cacheRecords,this.cachingEnabled&&chrome.storage.onChanged.addListener(this.updateRecords.bind(this)),this.saveRecordWithID=this.saveRecordWithID.bind(this),this.saveRecord=this.saveRecord.bind(this),this.getRecord=this.getRecord.bind(this),this.getRecords=this.getRecords.bind(this)}static getStorageType(){return new Promise((e=>{StorageService.getRecordFromStorage("storageType","sync").then((t=>{e(t||RQ.configs.storageType)}))}))}static setStorageType(e){return StorageService.saveRecordInStorage({storageType:e},"sync")}getRecords(e,t){const r=this;return new Promise(((n,a)=>{r.cachingEnabled&&r.isRecordsFetched&&!t?n(r.filterRecordsByType(r.records,e)):(r.records.length=0,r.DB.get(null,(function(t){for(let e in t)r.hasPrimaryKey(t[e])&&r.records.push(t[e]);r.isRecordsFetched=!0,n(r.filterRecordsByType(r.records,e))})))}))}hasPrimaryKey(e){for(let t=0;t<this.primaryKeys.length;t++)if(void 0!==e[this.primaryKeys[t]])return!0;return!1}filterRecordsByType(e,t){return t?e.filter((e=>(e.objectType||RQ.OBJECT_TYPES.RULE)===t)):e}saveRecord(e){return new Promise(((t,r)=>{this.DB.set(e,t)}))}saveRecordWithID(e){return new Promise((t=>{this.DB.set({[e.id]:e},t)}))}static saveRecordInStorage(e,t){return new Promise((r=>chrome.storage[t].set(e,r)))}static getRecordFromStorage(e,t){return new Promise((r=>chrome.storage[t].get(e,(t=>r(t[e])))))}getRecord(e){const t=this;return new Promise((r=>t.DB.get(e,(t=>r(t[e])))))}removeRecord(e){const t=this;return new Promise((r=>t.DB.remove(e,r)))}getCachedRecord(e){const t=this.getCachedRecordIndex(e);return this.records[t]}getCachedRecordIndex(e){for(let t=0;t<this.records.length;t++){if(this.records[t].id===e)return t}return-1}updateRecords(e,t){var r,n,a,s;if("local"===t&&e.hasOwnProperty("storageType")&&e.storageType.newValue)this.switchStorageType(e.storageType.newValue);else if(this.DB===chrome.storage[t])for(s in e)if(e.hasOwnProperty(s)){if(r=e[s],a=-1!==(n=this.getCachedRecordIndex(s)),void 0!==r.newValue){if(!this.hasPrimaryKey(r.newValue))continue;a?this.records[n]=r.newValue:this.records.push(r.newValue)}void 0!==r.oldValue&&void 0===r.newValue&&a&&this.records.splice(n,1)}}printRecords(){this.DB.get(null,(function(e){console.log(e)}))}clearDB(){this.DB.clear()}switchStorageType(e){if(chrome.storage[e]===this.DB)return void Logger.log("Already on the same storage type. Doing nothing!");Logger.log("Changing default storageType to",e);const t=this.DB;this.DB=chrome.storage[e],this.records.length=0;const r=this;t.get(null,(n=>{const a=[];for(let t in n)n.hasOwnProperty(t)&&r.hasPrimaryKey(n[t])&&(chrome.storage[e].set({[t]:n[t]}),a.push(t));t.remove(a)}))}})}(window),window.RQ=window.RQ||{},RQ.PreDefinedFunction=function(e,t){for(var r in this.name=e,t)this[r]=t[r];var n;if(this.argument.constructor===Array&&this.argument.length>0){n=this.argument[0];for(var a=1;a<this.argument.length;a++)n+="("+RQ.PreDefinedFunction.patterns.COMMA+this.argument[a]+")?"}else n=this.argument;this.pattern=this.pattern||new RegExp(this.name+"\\("+n+"\\)","ig")},RQ.PreDefinedFunction.patterns={STRING:"((?!rq_).)+",NUMBER:"[0-9]+",COMMA:" *, *"},RQ.PreDefinedFunction.prototype={argument:RQ.PreDefinedFunction.patterns.STRING,eval:function(e){var t=this;return"function"!=typeof this.argumentEvaluator?e:e.replace(this.pattern,(function(e){var r=e.match(new RegExp(t.name+"\\((.*)\\)","i")),n=[];return null!=r&&r.length>1?(r[1].split(",").forEach((function(e){n.push(e.trim())})),t.argumentEvaluator.apply(t,n)):e}))}},window.RQ=window.RQ||{},RQ.PreDefinedFunctions={},RQ.registerPredefinedFunction=function(e,t){RQ.PreDefinedFunctions[e]=new RQ.PreDefinedFunction(e,t)},RQ.registerPredefinedFunction("rq_rand",{description:"Generate Random Number",usage:"rq_rand(4) (Max 8 digits allowed)",argument:RQ.PreDefinedFunction.patterns.NUMBER,getRandomNumber:function(e){return Math.ceil(Math.random()*Math.pow(10,e))},argumentEvaluator:function(e){var t=Math.min(e,8),r=this.getRandomNumber(t);for(r=r.toString();r.length<t;)r+="0";return r}}),RQ.registerPredefinedFunction("rq_encode",{description:"Encode part of URL",usage:"rq_encode(user+test@example.com)",argument:RQ.PreDefinedFunction.patterns.STRING,argumentEvaluator:encodeURIComponent}),RQ.registerPredefinedFunction("rq_decode",{description:"Encode part of URL",usage:"rq_decode(user%2Btest%40example.com)",argument:RQ.PreDefinedFunction.patterns.STRING,argumentEvaluator:decodeURIComponent}),RQ.registerPredefinedFunction("rq_increment",{description:"Increment a number optionally by a step",usage:"rq_increment(3,5)",argument:[RQ.PreDefinedFunction.patterns.NUMBER,RQ.PreDefinedFunction.patterns.NUMBER],argumentEvaluator:function(e,t){return t=t||1,parseInt(e)+parseInt(t)}}),RQ.registerPredefinedFunction("rq_decrement",{description:"Decrement a number optionally by a step",usage:"rq_increment(5,2)",argument:[RQ.PreDefinedFunction.patterns.NUMBER,RQ.PreDefinedFunction.patterns.NUMBER],argumentEvaluator:function(e,t){return t=t||1,parseInt(e)-parseInt(t)}}),function(e){e.RuleMatcher={},RuleMatcher.populateMatchesInString=function(e,t){return t.forEach((function(t,r){0!==r&&(t=t||"",e=e.replace(new RegExp("[$]"+r,"g"),t))})),e},RuleMatcher.checkRegexMatch=function(e,t,r){var n,a=RQ.Utils.toRegex(e);return a&&-1!==t.search(a)?(n=a.exec(t)||[],RuleMatcher.populateMatchesInString(r,n)):null},RuleMatcher.checkWildCardMatch=function(e,t,r){var n,a,s,o,i=[];for(t="|"+t+"|",n=(e="|"+e+"|").split("*"),a=0;a<n.length;a++){if(s=n[a],-1===(o=t.indexOf(s)))return null;0===o?i.push(""):i.push(t.substr(0,o)),t=t.slice(o+s.length)}return RuleMatcher.populateMatchesInString(r,i)},RuleMatcher.matchUrlWithRuleSource=function(e,t,r){for(var n=e.operator,a=RQ.Utils.extractUrlComponent(t,e.key),s=e.value,o=RQ.BLACK_LIST_DOMAINS||[],i=0;i<o.length;i++)if(-1!==t.indexOf(o[i]))return null;return RuleMatcher.matchUrlCriteria(a,n,s,r)},RuleMatcher.matchUrlWithPageSource=function(e,t){var r=e.operator,n=RQ.Utils.extractUrlComponent(t,e.key),a=e.value;return RuleMatcher.matchUrlCriteria(n,r,a,null)},RuleMatcher.matchUrlCriteria=function(e,t,r,n){if(!e)return;const a=n||"";switch(t){case RQ.RULE_OPERATORS.EQUALS:if(r===e)return a;break;case RQ.RULE_OPERATORS.CONTAINS:if(-1!==e.indexOf(r))return a;break;case RQ.RULE_OPERATORS.MATCHES:return RuleMatcher.checkRegexMatch(r,e,a);case RQ.RULE_OPERATORS.WILDCARD_MATCHES:return RuleMatcher.checkWildCardMatch(r,e,a)}return null},RuleMatcher.matchUrlWithRulePairs=function(e,t,r){var n,a,s,o=t;for(n=0;n<e.length;n++)void 0!==(s=e[n]).destination?s.destination:null,RuleMatcher.matchRequestWithRuleSourceFilters(s.source.filters,r)&&null!==(a=RuleMatcher.matchUrlWithRuleSource(s.source,o,s.destination))&&(o=a);return o!==t?o:null},RuleMatcher.matchRequestWithRuleSourceFilters=function(e,t){return!e||!t||(Array.isArray(e)||(e=[e]),e.every((e=>{for(let r in e){let n=e[r]||[];switch("Object"===n?.constructor?.name&&(n=[n]),r){case RQ.RULE_SOURCE_FILTER_TYPES.PAGE_URL:if(!n.every((e=>RuleMatcher.matchPageUrlFilter(e,t))))return!1;break;case RQ.RULE_SOURCE_FILTER_TYPES.REQUEST_METHOD:if(!n.some((e=>t.method===e)))return!1;break;case RQ.RULE_SOURCE_FILTER_TYPES.RESOURCE_TYPE:if(!n.some((e=>t.type===e)))return!1}}return!0})))},RuleMatcher.matchPageUrlFilter=function(t,r){const n=e.tabService.getTabUrl(r.tabId);return null!==RuleMatcher.matchUrlCriteria(n,t.operator,t.value)},RuleMatcher.matchValueForPredefinedFunctions=function(e,t){if(!e)return e;for(var r in t){e=t[r].eval(e)}return e}}(window),RQ.flags=["response_rule_enabled"];